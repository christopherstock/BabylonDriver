function toEulerAngles(e){"use strict";var t,i,s,o,n,h,a,r,l,c,d,p;return t=BABYLON.Vector3.Zero(),i=e.x,s=e.y,o=e.z,n=e.w,h=i*i,a=s*s,r=o*o,l=Math.atan2(2*(s*n-i*o),1-2*(a+r)),c=Math.asin(2*(i*s+o*n)),d=Math.atan2(2*(i*n-s*o),1-2*(h+r)),p=i*s+o*n,p>.499?(l=2*Math.atan2(i,n),d=0):-.499>p&&(l=-2*Math.atan2(i,n),d=0),t.x=c,t.y=l,t.z=d,t}function Car(e,t,i,s,o,n,h,a,r,l,c,d,p){"use strict";p=p||{},this.scene=e,this.world=t,this.bodyMeshPath=i,this.bodyMeshName=s,this.wheelMeshPath=o,this.wheelMeshName=n,this.bodyMaterial=h,this.wheelMaterial=a,this.wheel_rl_position=r,this.wheel_rr_position=l,this.wheel_fl_position=c,this.wheel_fr_position=d,this.wheelsOptions={directionLocal:new CANNON.Vec3(0,0,-1),suspensionStiffness:30,suspensionRestLength:.1,frictionSlip:5,dampingRelaxation:2.3,dampingCompression:4.4,maxSuspensionForce:1e5,rollInfluence:.01,axleLocal:new CANNON.Vec3(0,1,0),chassisConnectionPointLocal:new CANNON.Vec3(1,1,0),maxSuspensionTravel:.3,customSlidingRotationalSpeed:-30,useCustomSlidingRotationalSpeed:!0},this.lenk=0,this.dyn=0,this.direction=1,this.scaleFactor="number"==typeof p.scaleFactor?p.scaleFactor:1;var u="boolean"==typeof p.invertX?p.invertX:!1;u?this.scale=new BABYLON.Vector3(-this.scaleFactor,this.scaleFactor,this.scaleFactor):this.scale=new BABYLON.Vector3(this.scaleFactor,this.scaleFactor,this.scaleFactor),this.shadowGenerator="object"==typeof p.shadowGenerator?p.shadowGenerator:null,this.bodyMass="number"==typeof p.bodyMass?p.bodyMass:0,this.firstPos="CANNON.Vec3"==typeof p.firstPos?p.firstPos:new CANNON.Vec3(0,0,0),this.bodyCollisionFilterGroup="number"==typeof p.bodyCollisionFilterGroup?p.bodyCollisionFilterGroup:0,this.bodyCollisionFilterMask="number"==typeof p.bodyCollisionFilterMask?p.bodyCollisionFilterMask:0,this.msgCallback="function"==typeof p.msgCallback?p.msgCallback:null,this.onLoadSuccess="function"==typeof p.onLoadSuccess?p.onLoadSuccess:null,Car.prototype._babylon_addBody=function(e){var t,i,s;for(this.b_bodyRoot=e[0],this.b_bodyRoot.name=this.bodyMeshName,t=BABYLON.Quaternion.RotationAxis(new BABYLON.Vector3(0,1,0),Math.PI/2),i=toEulerAngles(t),s=1;s<e.length;s+=1)e[s].rotationQuaternion=t,e[s].rotation=new BABYLON.Vector3(i.x,i.y,i.z);if(this.b_bodyRoot.scaling=this.scale,null!==this.shadowGenerator)for(s=1;s<e.length;s+=1)this.shadowGenerator.getShadowMap().renderList.push(e[s]);this.approxBox=e[1]},Car.prototype._cannon_addBody=function(e){var t,i;t=e[0].negate().add(e[1]),t.scaleInPlace(.5),t.x=Math.abs(t.x),t.y=Math.abs(t.y),t.z=Math.abs(t.z),t.scaleInPlace(this.scaleFactor),i=new CANNON.Box(new CANNON.Vec3(t.x,t.z,t.y)),this.c_bodyRoot=new CANNON.Body({mass:this.bodyMass,material:this.bodyMaterial}),this.c_bodyRoot.addShape(i),0!==this.bodyCollisionFilterGroup&&(this.c_bodyRoot.collisionFilterGroup=this.bodyCollisionFilterGroup,this.c_bodyRoot.collisionFilterMask=this.bodyCollisionFilterMask),this.c_bodyRoot.position.set(this.firstPos.x,this.firstPos.y,this.firstPos.z),this.world.add(this.c_bodyRoot),this.vehicle=new CANNON.RaycastVehicle({chassisBody:this.c_bodyRoot})},Car.prototype._loadWheels=function(){var e=this;BABYLON.SceneLoader.ImportMesh("",this.wheelMeshPath,this.wheelMeshName,this.scene,function(t){e._babylon_addWheels(t),e._cannon_addWheels(minmaxBox(t))})},Car.prototype._babylon_addWheels=function(e){var t,i,s,o,n,h,a;if(t=e[0],t.scaling=this.scale,null!==this.shadowGenerator)for(a=1;a<e.length;a+=1)this.shadowGenerator.getShadowMap().renderList.push(e[a]);for(n=BABYLON.Quaternion.RotationAxis(new BABYLON.Vector3(0,1,0),Math.PI/2),a=1;a<e.length;a+=1)e[a].rotationQuaternion=n;for(i=new BABYLON.Mesh("",this.scene),a=1;a<e.length;a+=1)h=e[a].createInstance(""),h.parent=i,null!==this.shadowGenerator&&this.shadowGenerator.getShadowMap().renderList.push(h);for(i.scaling=this.scale,s=new BABYLON.Mesh("",this.scene),a=1;a<e.length;a+=1)h=e[a].createInstance(""),h.parent=s,null!==this.shadowGenerator&&this.shadowGenerator.getShadowMap().renderList.push(h);for(s.scaling=this.scale,o=new BABYLON.Mesh("",this.scene),a=1;a<e.length;a+=1)h=e[a].createInstance(""),h.parent=o,null!==this.shadowGenerator&&this.shadowGenerator.getShadowMap().renderList.push(h);o.scaling=this.scale,this.b_wheels=[],this.b_wheels.push(o),this.b_wheels.push(s),this.b_wheels.push(i),this.b_wheels.push(t)},Car.prototype._cannon_addWheels=function(e){var t=Math.abs(e[0].y-e[1].y)/2*this.scaleFactor;this.wheelsOptions.radius=t,this.wheelsOptions.chassisConnectionPointLocal.set(this.wheel_fr_position.x,this.wheel_fr_position.y,this.wheel_fr_position.z),this.vehicle.addWheel(this.wheelsOptions),this.wheelsOptions.chassisConnectionPointLocal.set(this.wheel_fl_position.x,this.wheel_fl_position.y,this.wheel_fl_position.z),this.vehicle.addWheel(this.wheelsOptions),this.wheelsOptions.chassisConnectionPointLocal.set(this.wheel_rr_position.x,this.wheel_rr_position.y,this.wheel_rr_position.z),this.vehicle.addWheel(this.wheelsOptions),this.wheelsOptions.chassisConnectionPointLocal.set(this.wheel_rl_position.x,this.wheel_rl_position.y,this.wheel_rl_position.z),this.vehicle.addWheel(this.wheelsOptions),this.vehicle.addToWorld(this.world),null!==this.onLoadSuccess&&this.onLoadSuccess()}}var minmaxBox=function(e){"use strict";var s,o,n,h,a,r,t=null,i=null;for(s=1;s<e.length;s+=1)o=e[s],n=o.getBoundingInfo().boundingBox,h=BABYLON.Matrix.RotationYawPitchRoll(o.rotation.y,o.rotation.x,o.rotation.z),a=BABYLON.Vector3.TransformCoordinates(n.minimumWorld,h),r=BABYLON.Vector3.TransformCoordinates(n.maximumWorld,h),t?(t.MinimizeInPlace(a),i.MaximizeInPlace(r)):(t=a,i=r);return[t,i]};Car.prototype.load=function(){"use strict";this.msgCallback&&this.msgCallback("make DS3...");var e=this;BABYLON.SceneLoader.ImportMesh("",this.bodyMeshPath,this.bodyMeshName,this.scene,function(t){e._babylon_addBody(t);var i=minmaxBox(t);e._cannon_addBody(i),e._loadWheels()})},Car.prototype.update=function(){"use strict";var e,t,i,s;e=function(e,t,i){return new BABYLON.Quaternion(-e.w*t*i.x+e.x*-i.w+e.z*i.y-e.y*i.z,-e.w*t*i.z+e.z*-i.w+e.y*i.x-e.x*i.y,-e.w*t*i.y+e.y*-i.w+e.x*i.z-e.z*i.x,-e.w*t*-i.w-e.x*i.x-e.z*i.z-e.y*i.y)},t=BABYLON.Quaternion.RotationAxis(new BABYLON.Vector3(0,0,1),Math.PI),i=this.vehicle.chassisBody,this.b_bodyRoot.position=new BABYLON.Vector3(i.position.x,i.position.z,i.position.y-.02),this.b_bodyRoot.rotationQuaternion=e(i.quaternion,1,new BABYLON.Quaternion(0,0,0,-1)),this.vehicle.updateWheelTransform(0),i=this.vehicle.getWheelTransformWorld(0),this.b_wheels[0].position=new BABYLON.Vector3(i.position.x,i.position.z,i.position.y),this.b_wheels[0].rotationQuaternion=e(i.quaternion,1,new BABYLON.Quaternion(0,0,0,-1)),this.vehicle.updateWheelTransform(1),i=this.vehicle.getWheelTransformWorld(1),this.b_wheels[1].position=new BABYLON.Vector3(i.position.x,i.position.z,i.position.y),this.b_wheels[1].rotationQuaternion=e(i.quaternion,1,t),this.vehicle.updateWheelTransform(2),i=this.vehicle.getWheelTransformWorld(2),this.b_wheels[2].position=new BABYLON.Vector3(i.position.x,i.position.z,i.position.y),this.b_wheels[2].rotationQuaternion=e(i.quaternion,1,new BABYLON.Quaternion(0,0,0,-1)),this.vehicle.updateWheelTransform(3),i=this.vehicle.getWheelTransformWorld(3),this.b_wheels[3].position=new BABYLON.Vector3(i.position.x,i.position.z,i.position.y),this.b_wheels[3].rotationQuaternion=e(i.quaternion,1,t),s=toEulerAngles(this.b_bodyRoot.rotationQuaternion),this.b_bodyRoot.rotation=new BABYLON.Vector3(s.x,s.y,s.z)},Car.prototype.setPosition=function(e){"use strict";this.vehicle.chassisBody.position.set(e.x,e.y,e.z),this.vehicle.chassisBody.quaternion.set(0,0,0,1),this.vehicle.chassisBody.angularVelocity.set(0,0,0),this.vehicle.chassisBody.velocity.set(0,0,0)},Car.prototype.steering=function(e){"use strict";this.vehicle.setSteeringValue(e,0),this.vehicle.setSteeringValue(e,1)},Car.prototype.brake=function(e){"use strict";this.vehicle.applyEngineForce(0,0),this.vehicle.applyEngineForce(0,1),this.vehicle.setBrake(e,0),this.vehicle.setBrake(e,1),this.vehicle.setBrake(e,2),this.vehicle.setBrake(e,3)},Car.prototype.accelerate=function(e){"use strict";this.vehicle.setBrake(0,0),this.vehicle.setBrake(0,1),this.vehicle.setBrake(0,2),this.vehicle.setBrake(0,3),this.vehicle.applyEngineForce(e,0),this.vehicle.applyEngineForce(e,1)},Car.prototype.moves=function(e,t,i,s,o){"use strict";if(1===s&&this.lenk>=-.5&&(this.lenk-=.01,this.steering(this.lenk)),1===i&&this.lenk<=.5&&(this.lenk+=.01,this.steering(this.lenk)),0===i&&0===s&&(this.lenk<0?(this.lenk+=.01,this.steering(this.lenk)):this.lenk>0&&(this.lenk-=.01,this.steering(this.lenk)),Math.abs(this.lenk)<.01&&(this.lenk=0,this.steering(this.lenk))),1===e&&1===this.direction?(this.getSpeed()<50?this.dyn=8e3:this.getSpeed()<100?this.dyn=7e3:this.getSpeed()<150?this.dyn=6e3:this.getSpeed()<230?this.dyn=4e3:this.dyn=0,this.accelerate(this.dyn)):1===e&&-1===this.direction?(this.getSpeed()<50?this.dyn=-2e3:this.dyn=0,this.accelerate(this.dyn)):this.accelerate(0),1===o&&this.getSpeed()<5&&(this.direction*=-1),1===t){this.dyn=0;var n=50;this.brake(n)}},Car.prototype.createFollowCamera=function(){"use strict";var e=new BABYLON.FollowCamera("FollowCam",new BABYLON.Vector3(0,15,-45),this.scene);return e.target=this.b_bodyRoot,e.radius=8,e.heightOffset=2,e.rotationOffset=90,e.cameraAcceleration=.05,e.maxCameraSpeed=20,e},Car.prototype.getSpeed=function(){"use strict";return 3.6*this.c_bodyRoot.velocity.norm()},Car.prototype.getLenk=function(){"use strict";return this.lenk},Car.prototype.getDirection=function(){"use strict";return this.direction},Car.prototype.getAltitude=function(){"use strict";return this.c_bodyRoot.position.z},Car.prototype.getCarMainMesh=function(){"use strict";return this.approxBox};